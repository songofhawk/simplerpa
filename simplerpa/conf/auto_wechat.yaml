name: "微信获取数据"
ver: 0.1
#screen_width: 3440
#screen_height: 1440
range: !rect l:0, r:1920, t:0, b:1080
time_scale: 1
states:
  - name: "当前桌面"
    id: 1
    find:
      window:
        win_class: "WeChatMainWndForPC"
#        title: "微信"
        fail_action: raise_error('没有找到微信！')
        activate: True
        wait: 1
    transition:
      # 点击
      action:
        - wechat = get_window_rect(find_result.hwnd)
        - print(wechat)
      wait: 1
  - name: "微信聊天窗口"
    id: 2
    # 这里简化了操作，假设微信总是处于聊天窗口，也可以增加查找节点，再切换回聊天窗
    find:
      image:
        snapshot: wechat
        # 直接在整个微信对话框内搜索
        template: auto_wechat/wechat_logo.png
        fail_action: raise_error('当前没有处于微信聊天窗口！')
        result_name: chat_logo
    transition:
      # 右击第一个卡片
      action: click(find_result.rect_on_screen.center)
      wait: 1
  - name: "聊天列表"
    id: 3
    action:
      - move(wechat.topleft.offset(100,200))
    find:
      image:
        snapshot: wechat
        # 直接在整个微信对话框内搜索
        template: auto_wechat/group_name.png
#        debug: True
      fail_action: raise_error('没找到【网约沟通】群！')
      scroll:
        one_page: -200  # 负数是假设目前看到的是列表顶端，内容向上滚
        page_count: 20
        find_mode: "Any"
    transition:
      # 点击对应的聊天
      action:
        - print(find_result.rect_on_screen)
        - click(find_result.rect_on_screen.center)
      wait: 2
  - name: "网约沟通群内容上沿"
    id: 4
    find:
      image:
        template: auto_wechat/wangyue_title.png
        snapshot: ScreenRect(wechat.left+304, wechat.left+370, wechat.top+65, wechat.top+900)
      fail_action: raise_error('没找到网约沟通标题')
    transition:
      action:
        - content_top = find_result.rect_on_screen.bottom
  - name: "网约沟通群内容下沿"
    id: 5
    find:
      image:
        template: auto_wechat/chat_toolbar.png
        snapshot: ScreenRect(wechat.left+304, wechat.left+370, wechat.top+65, wechat.top+900)
      fail_action: raise_error('没找到网约沟通标题')
    transition:
      action:
        - content_bottom = find_result.rect_on_screen.top
        - content_left = find_result.rect_on_screen.left
        - content = ScreenRect(content_left, content_left+430, content_top, content_bottom)
  - name: "网约沟通群内容监控"
    id: 5
    monitor:
      snapshot: content
      interval: 0.3
      time: None
      scroll: up
      #        confidence: 0.3
      debug: True
    find:
      image:
        template: auto_wechat/chat_head.png
        snapshot: ScreenRect(content.left, content.right, content.top+monitor_result.position, content.bottom)
        confidence: 0.3
#        debug: True
        detect_all: True
      #      scroll:
      #        one_page: 800  # 负数是假设目前看到的是列表顶端，内容向上滚
      #        page_count: 20
#      fail_action: raise_error('没找到人物头像')
    foreach:
      in_items: find_result
      item: head
      action:
        - head_rect = head.rect_on_screen
      sub_states:
        - id: 60
          name: 1条聊天记录
          check:
            image:
              snapshot: head_rect.snap_right(30, 70)
              template: auto_wechat/angle.png
              for_not_exist: True
#              debug: True
            fail_action: level_return(state.id)
          find:
            image:
              snapshot: head_rect.topleft.offset_rect(60,45, 87, 176)
              template: auto_wechat/snapshot_thumbnail.png
              confidence: 0.4
#              debug: True
#            fail_action: level_return(state.id)
          transition:
            action:
              - click(head_rect.topleft.offset(80,65))
              - wait(0.5)
        - id: 62
          name: 检测图片窗口
#          check:
#            image:
#              snapshot: ScreenRect.center_expand(500,1200)
#              template: auto_wechat/completed.png
#              confidence: 0.5
#              auto_scale: (0.5,2)
##              debug: True
#            result_name: complete_text
          find:
            window:
              win_class: "ImagePreviewWnd"
              title: "图片查看"
              fail_action: raise_error('没有找到图片查看窗口！')
              activate: True
              wait: 1
          transition:
            # 点击
            action:
              - form = get_window_rect(find_result.hwnd)
              - print(wechat)
            wait: 1
        - id: 63
          name: "提取form信息"
          form:
            file: "result.csv"
            snapshot: form
            part_splitter:
              name: "用分割符切割窗口"
              start:
                template: auto_wechat/form_start.png
                to_binary:
                  foreground: (153,153,153)
      #            background: (255,255,255)
                  tolerance: 0.1
                detect_all: True
      #          debug: True
                auto_scale: (1,1.5)
              end:
                template: auto_wechat/form_end.png
                to_binary:
                  foreground: (239,99,31)
                  tolerance: 0.3
                detect_all: True
                auto_scale: (0.8,2)
                confidence: 0.65
                debug: True
            fields:
              - name: time
                feature:
                  template: auto_wechat/icon_time.png
                  auto_scale: (0.8,1.5)
                  to_binary:
                    foreground: (155,155,155)
                    tolerance: 0.1
                position: feature_rect.snap_right(330, 6)
                foreground: (155,155,155)
                tolerance: 0.3
              - name: start
                feature:
                  template: auto_wechat/icon_start_big.png
                  auto_scale: (0.8,1.5)
                  to_binary:
                    foreground: (64,61,80)
                    tolerance: 0.1
                position: feature_rect.snap_right(400)
                foreground: (25,25,25)
                tolerance: 0.1
              - name: end
                feature:
                  template: auto_wechat/icon_end_big.png
                  auto_scale: (0.8,1.5)
                  to_binary:
                    foreground: (237,104,44)
                    tolerance: 0.2
                position: feature_rect.snap_right(400)
                foreground: (25,25,25)
                tolerance: 0.1
              - name: price
                feature:
                  template: auto_wechat/icon_rmb_small.png
                  to_binary:
                    foreground: (237,104,44)
                    tolerance: 0.3
                  auto_scale: (0.8,2)
                  confidence: 0.65
                  debug: True
                debug: True
                position: feature_rect.snap_right(100)
                foreground: (237,104,44)
                tolerance: 0.3
      #          debug: True
          transition:
            action:
              - df = df.append({'time':time_str, 'start':start_str, 'end':end_str, 'price':price_str}, ignore_index=True)

    transition:
      wait: 1
  - name: "内容总结"
    id: 5
    action:
      - df.to_excel('./result.xlsx')

